
0. Content

1. Introduction
   1.1 Overview
   1.2 Pre-requisites

2. Setup resource agent
   2.1 install resoruce agent
   2.2 adapt sudoers
   2.3 stop HANA
   2.4 adapt HANA's global.ini
   2.5 install srHook for HANA
   2.6 configure SAPHanaSR-ScaleOut resources
   2.7 start HANA

3. Test
9. Appendix



1. Introduction

1.1 Overwiew

# TODO
We use the hook method srConnectionChanged().

1.2 Pre-requisites

- SLES-for-SAP 11 SP 4 with patches installed, configured, running
- SLE-HA 11 SP4 cluster with patches installed, empty cluster running
	note: PTF for parallel stonith should be applied
- SAP HANA SPS 11 rel. 1 installed, configured for System Replication, running
- latest SAPHanaSR-ScaleOut and SAPHanaSR-ScaleOut-doc RPMs



2. Setup

2.1 install resource agent

# rpm -U SAPHanaSR-ScaleOut-0.160.beta-15.1.noarch.rpm SAPHanaSR-ScaleOut-doc-0.160.beta-15.1.noarch.rpm

Install resource agent on all nodes.


2.2 adapt sudoers

# visudo
...
# SAPHanaSR-ScaleOur needs for srHook
ha1adm ALL=(ALL) NOPASSWD: /usr/sbin/crm_attribute -n hana_ha1_glob_srHook -v *
# %sapsys localhost=(root) NOPASSWD: /usr/sbin/crm_attribute -n hana_*_glob_srHook -v *
#

Adapt the sudoers file on all nodes.


2.3 stop HANA

# su - ${SID}adm
# HDB stop


2.4 adapt HANA's global.ini

You need
- path to SAPHanaSR hook provider executable 

# FIL="/hana/shared/$SID/global/hdb/custom/config/global.ini"
# cp -a ${FIL} ${FIL}.bak

# vi $FIL
...
[ha_dr_provider_SAPHanaSR]
provider = SAPHanaSR
path = /hana/shared/srhook/
execution_order = 1

[trace]
ha_dr_saphanasr = info
...

Adapt the global.ini on both sites.
# TODO comments in global.ini?


2.5 install srHook for HANA

You need
- path to SAPHanaSR hook provider script
- path to SAPHanaSR hook provider executable 

Stop HANA on both sites.
Stop secondary site first, than primary.

# su - ${SID}adm 
# HDB stop
# exit

Install hook provider

# FIL=/usr/share/SAPHanaSR-ScaleOut/SAPHanaSR.py
# mkdir /hana/shared/srhook/
# chown ${SID}adm.sapsys /hana/shared/srhook/
# cp ${FIL} /hana/shared/srhook
# su - ${SID}adm
# python -O -m py_compile SAPHanaSR.py
# ls -l SAPHanaSR.pyo

Install the hook on both sites.
To activate the hook, start HANA on both sites.
Start primary site first, than secondary.

# su - ${SID}adm 
# HDB start
# HDBSettings.sh landscapeHostConfiguration.py
# HDBSettings.sh systemReplicationStatus.py
# exit


2.6 configure SAPHanaSR-ScaleOut resources

You need
- for HAWK login: URL, hacluster user, hacluster passwd 
- for SAPHanaSR: SID, Instance Nr, virtual IP.
	F.e.
	SID		HA1
	Instance Nr	10
	virtual IP	192.168.201.150

# TODO
# rchawk status

- connect to the HAWK web Konsole on one of the cluster nodes
# firefox https://192.168.201.151:7630/
- select SAPHanaSR-ScaleOut wizard
- Enter SID, Instance Nr, and virtual IP
- Review wizard's proposal
- Deploy the configuration to the SLe-HA cluster
- Double-check the CRM defaults
- Occasionally, start the resources



3. Test

3.1 Test sudoers

# su - ${SID}adm
# TODO /usr/sbin/crm_attribute -n ...


3.2 test use of srHook

# SAPHanaSR-showAttr
...


3.3 more tests

# TODO test

# SAPHanaSR-showAttr --sid=HA1
Global prim sec  sec_sync_state srHook 
---------------------------------------
global WDF1 ROT1 SOK            SOK    

Site lpt        lss mns    srr 
-------------------------------
ROT1 30         3   suse02 S   
WDF1 1456933738 4   suse01 P   

Hosts  clone_state roles                         site 
------------------------------------------------------
suse01 PROMOTED    master1:master:worker:master  WDF1 
suse02 DEMOTED     master1:master:worker:master  ROT1 
suse03 DEMOTED     master2:slave:worker:slave    WDF1 
suse04 UNDEFINED   master3:slave:worker:standby  ROT1 
suse05 DEMOTED     master3:slave:standby:standby WDF1 
suse06 DEMOTED     master2:slave:standby:slave   ROT1 
suse07             :shtdown:shtdown:shtdown           
suse08             :shtdown:shtdown:shtdown           


if no srHook status is shown, the hook is not used.
Pls. check and fix the setup
 
 

9. Appendix

http://help.sap.com/saphelp_hanaplatform/helpdata/en/13/67c8fdefaa4808a7485b09815ae0f3/content.htm
https://scn.sap.com/thread/3709590
http://help.sap.com/saphelp_hanaplatform/helpdata/en/12/00ab8ef0c54c54be2d0e7f5327f7ed/content.htm?frameset=/en/13/67c8fdefaa4808a7485b09815ae0f3/frameset.htm&current_toc=/en/00/0ca1e3486640ef8b884cdf1a050fbb/plain.htm&node_id=413
http://help.sap.com/saphelp_hanaplatform/helpdata/en/5d/f2e766549a405e95de4c5d7f2efc2d/content.htm
http://scn.sap.com/community/hana-in-memory/blog/2015/12/14/sap-hana-sps-11-whats-new-ha-and-dr--by-the-sap-hana-academy
https://help.sap.com/saphelp_hanaplatform/helpdata/en/3f/1a6a7dc31049409e1a9f9108d73d51/content.htm

SAPHanaSR-Setup-Guide.pdf
https://www.susecon.com/doc/2015/sessions/TUT19921.pdf

SAPHanaSR-ScaleOut(7), ocf_suse_SAPHanaController(7),
ocf_suse_SAPHanaTopology(7),
crm_no_quorum_policy(7), stonith_sbd(7),
python(1)
#
